### 药品库第二版设计

#### 数据库表设计（药品库）

* 药品表：med_d2d.medications。基本信息：CFDA的信息；补充 药理分类、疾病分类 字段；依据产品类型推断内部分类，补充字段。
* 药品属性表：med_d2d.medication_fields。说明书信息：CFDA外的详细信息。
* 为方便后续药械库的扩展和管理，将说明书属性字段单独管理，创建属性表（med_dad.spec_fields）及其管理附加表（med_d2d.spec_field_groups/med_d2d.field_collections）



### 药品库第四版设计

#### 药品库数据模型

`渠道` 关联 `药品SPU`（唯一属性：批准文号、产品名称(通用名)、本位码、规格、生产厂家；基本属性：商品名称、成分、药理、包装图等；关键属性：属性组 -> 适用症状/功能主治、限制类别等）

`药店` 从属于 `渠道` 关联 `商品sku`（唯一属性：药械字典，包装规格填写的名称和对应的图；销售属性：价格、库存）



### 拆单逻辑

#### 规则

* ##### 顺序

  通用：最小拆单数（所需药店数）> 自营药店数 > 药店到收货距离（最近的药店）> 配送方式最多的药店（O2O > 快递 > 自取）

  DTP：根据收货地址选择其省内药店，并按照距离排序供用户选择（如果无药店留空）

* ##### 合并

  因为DTP是用户自行选择需要的药店，并且是每个DTP药品都会有对应药店进行选择，可能会选到同一个药店，最后下单时会把通用和DTP相同药店合并成一单。

* ##### 父子订单

  结果：支付行为是可能存在分批支付，所以支付未完成时只能看到父订单，当用户支付完成时父订单失效，子订单有效，此时用户只能看到子订单，退款只能在子订单上进行。

  存储：父订单中的运费、服务费、药品总价等于所有子订单的和，并且为了方便使用，父订单会冗余存储所有的药品详情。



#### 处理过程

如果满足DTP拆单逻辑，则把所有的DTP药店选出来进行DTP处理，剩下的药品走通用的拆弹逻辑。



### 处方技术方案

#### 约定术语

##### 术语

* 电子处方（ElectronicPrescrition）：通过互联网医院医生开具的线上处方。
* 纸质处方（PaperPrescrition）：通过线下实体医院医生开具的纸质处方。
* 补方：患者通过纸质处方购药时，在特定的业务场景下，需要将纸质处方转变成电子处方；这个过程就是补方。

##### 职责

开具处方、审核处方、处方留存。

#### 电子处方

一个标准的电子处方信息，需要主要包含以下内容：患者信息、医生信息、医院科室信息、诊断、处方内容、审核信息；为了业务扩展，我司会特有一些统计相关属性。

#### 纸质处方

因纸质处方是用户拍照后上传的，无法直观地区分出处方信息；在设计之时，将其单独维护，同时保留审核信息。纸质处方在特定场景下，通过补方，可以转变成电子处方。



### 支付技术方案

#### 业务设计

* med-payment是医联业务线和三方支付间桥梁
* 业务设计上保留着扩展其他三方支付的能力（暂时只支持通联支付）
* 虚拟账户作为支付中心的一个核心也是可扩展支持的（目前使用通联的虚拟账户）

#### 技术模块

##### 主要的编码部分主要分成三个部分，这三个部分做到模块隔离，业务分层

1. 支付路由 - 统一的业务支付接口，后面实现多个三方支付具体细节实现
2. 数据层 - 通用的支付数据层，提供统一的数据操作接口
3. 通知中心 - 作为和业务系统交互的出口，需要保证做到消息最终可达，实现退步重试和基本容错

##### 在技术层面还需要保证以下几个特性：

1. 所有对外的API保证幂等
2. 业务方在接收通知的时候需要保证通知中心的通知是可重入的
3. 因为存在系统间信息同步延迟，所以如果出现重复支付由业务方出发直接退款
4. 由于订单状态变更的延迟，而取消订单的情况，同样由业务方直接触发退款